<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Accepted request</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css">
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <!-- End Plugin css for this page -->
    <!-- inject:css -->
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="assets/css/style.css">
    <!-- End layout styles -->
     <link rel="shortcut icon" href="assets/images/logo.png" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
   <style type="text/css">

.navbar-menu-wrapper {
    justify-content: center; /* Centers children horizontally in a flex container */
}

.portal-label {
    margin-top: 15px;
    position: absolute; /* Position it absolutely within its parent */
    left: 50%; /* Move it to the center */
    transform: translateX(-50%); /* Shift it back by half its own width */
    white-space: nowrap; /* Prevent text from wrapping */
    color: black;
}

    
/* Style for the modal body */
.modal-body {
    padding: 20px;
}

/* Style for the labels */
label {
    display: inline-block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333; /* Label text color */
    width: 80px; /* Fixed width for labels */
}

/* Style for the user details (h3 elements) */
h3 {
    display: inline-block;
    margin-bottom: 10px;
    color: #555; 
    /* Text color for user details */
}

/* Style for the accept button */
#acceptButton {
    background-color: blue;
    color: white;
    border: none;
    padding: 10px 20px;
    cursor: pointer;
}

/* Style for the accept button on hover */
#acceptButton:hover {
    background-color: darkred;
}
/* CSS for the Edit button */
.edit-button {
    background-color: #3498db; /* Button background color */
    color: #fff; /* Button text color */
    padding: 8px 12px; /* Padding inside the button */
    border: none; /* Remove button border */
    border-radius: 4px; /* Rounded corners */
    cursor: pointer; /* Cursor style on hover */
    transition: background-color 0.3s ease; /* Smooth transition on hover */
}

/* Hover state for the Edit button */
.edit-button:hover {
    background-color: #2980b9; /* Darker background color on hover */
}

.modal-content {
    width: 100%;
}

.table_MODAL {
    display: table;
    width: 100%;
}

.row {
    display: table-row;
}

.cell {
    display: table-cell;
    padding: 5px;
    border-bottom: 1px solid #ddd; /* Optional: Add a border between rows */
}

.label {
    font-weight: bold;
}

.value {
    margin: 0;
}

.modal-buttons {
    text-align: center;
    padding: 15px;
    border-top: 1px solid #ddd; /* Optional: Add a border above the buttons */
}
        .table {
            margin-left: auto;
            margin-right: auto;
            /* Add additional styling as needed */
        }

        .table th, .table td {
            text-align: center;
        }

.hidden {
    display: none;
}


   #searchInput {
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 200px;
        transition: border-color 0.3s; /* Add a smooth transition effect for border color */
    }

    #searchInput:hover {
        border-color: GREEN; /* Change border color on hover */
    }

/* Style the button inside the footer */
#accept {
    background-color: #4CAF50; /* Green background color */
    color: white; /* Text color */
    padding: 10px 20px; /* Padding around the button content */
    border: none; /* Remove border */
    border-radius: 5px; /* Add border-radius for rounded corners */
    cursor: pointer; /* Change cursor on hover to indicate interactivity */
    display: inline-block; /* Make the button an inline-block element */
    margin-top: 20px;
}


/* Hover effect for the button */
#accept:hover {
    background-color: #45a049; /* Darker green on hover */
}

#Returned {
    background-color: #6c757d; /* Button background color */
    color: #fff; /* Button text color */
    border: 1px solid #6c757d; /* Button border color */
    padding: 8px 16px; /* Button padding */
    cursor: pointer; /* Cursor on hover */
    transition: background-color 0.3s, color 0.3s; /* Add a smooth transition effect for background color and text color */
}

#Returned:hover {
    background-color: #495057; /* Button background color on hover */
    color: #fff; /* Button text color on hover */
}

#allReturn {
    background-color: #28a745; /* Button background color */
    color: #fff; /* Button text color */
    border: 1px solid #218838; /* Button border color */
    padding: 8px 16px; /* Button padding */
    cursor: pointer; /* Cursor on hover */
    transition: background-color 0.3s, color 0.3s;
    border-radius: 5px; /* Add a smooth transition effect for background color and text color */
}

#allReturn:hover {
    background-color: #218838; /* Button background color on hover */
    color: #fff; /* Button text color on hover */
}


  </style>
  <body>
    <div class="container-scroller">
      <!-- partial:../../partials/_navbar.html -->
      <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
       <div class="text-center navbar-brand-wrapper d-flex align-items-left justify-content-left">
          <img src="assets/images/logo.png" style="width: 50px; height:50px;
          margin-left: 20px;
          margin-top: 5px;">
        </div>
        <div class="navbar-menu-wrapper d-flex align-items-stretch">
 <h4 class="portal-label">SHS IN SAN NICHOLAS III, BACOOR CITY</h4>
        </div>
      </nav>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
  
<div class="main-panel" style="margin-left: 10px; margin-right: 10px; width: 100%;">
    <div>
    <input type="text" id="searchInput" placeholder="Search by Name">
 <a href="allReturn_book.html" id="allReturn" class="btn btn-secondary">All Returned</a>
    </div>
    <table class="table table-dark" id="mytable" style="width: 100%;">
       <thead>
          <th>id</th>
           <th>name</th>
           <th>Tittle</th>
           <th>topic</th>
            <th>status</th>
            <th>Action</th>
       </thead>
       <tbody id="tbl"> 
       </tbody>
    </table>
</div>


<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">User</h5>
          <!-- Add an ID to the close button for easier selection -->
<button type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeModalButton">
    <span aria-hidden="true">&times;</span>
</button>

            </div>
            <div class="modal-body">
                <div class="table_MODAL">
                    <!-- Row 1 -->
                    <div class="row">
                        <div class="cell">
                            <label class="description">Author:</label>
                        </div>
                        <div class="cell">
                            <h3 class="value" id="Author">loading</h3>
                        </div>
                    </div>
                    <!-- Row 2 -->
                    <div class="row">
                        <div class="cell">
                            <label class="description">Bublisher:</label>
                        </div>
                        <div class="cell">
                            <h3 class="value" id="Publisher">loading</h3>
                        </div>
                    </div>
                    <!-- Row 3 -->
                    <div class="row">
                        <div class="cell">
                            <label class="description">Topic:</label>
                        </div>
                        <div class="cell">
                            <h3 class="value" id="topic">loading</h3>
                        </div>
                    </div>
                    <!-- Row 4 -->
                    <div class="row">
                        <div class="cell">
                            <label class="description">Book ID:</label>
                        </div>
                        <div class="cell">
                            <h3 class="value" id="BookID">loading</h3>
                        </div>
                    </div>
                     <!-- Row 5 -->
                    <div class="row" id="timer_row">
                        <div class="cell">
                            <label class="description">Remaining time:</label>
                        </div>
                        <div class="cell">
                            <h3 class="value" id="timer">loading</h3>
                        </div>
                    </div>
                    <div class="row">
                        <div class="cell">
                            <label class="description">Status:</label>
                        </div>
                        <div class="cell">
                            <h3 class="value" id="Status">loading</h3>
                        </div>
                    </div>
                    <footer>
                        <button id="accept">Received</button>
                    </footer>
                </div>
            </div>

        </div>
    </div>
</div>


        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>





<script type="text/javascript">

     var myID = localStorage.getItem("myID");
 localStorage.setItem("myID",myID);
     var myName = localStorage.getItem("myName");
 localStorage.setItem("myName",myName);


 document.addEventListener('DOMContentLoaded', function () {
    fetchRequest();

    // Add event listener to the search input
    document.getElementById('searchInput').addEventListener('input', function () {
        searchTable();
    });
});

var selectedUserId;

// Fetch requests for the current user
function fetchRequest() {
    // Get the user ID from localStorage
    var myID = localStorage.getItem("myID");

    // AJAX request to fetch data
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'fetch_requests.php?myID=' + encodeURIComponent(myID), true);
    xhr.setRequestHeader('Content-Type', 'application/json');

    // Handle the response from the PHP script
    xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
            if (xhr.status == 200) {
                try {
                    var response = JSON.parse(xhr.responseText);
                    if (response.status === 'success') {
                        displayRequests(response.data);
                    } else {
                        alert('Error: ' + response.message);
                    }
                } catch (e) {
                    console.error('Error parsing JSON response:', e);
                    alert('Invalid JSON response from server');
                }
            } else {
                alert('Request failed with status: ' + xhr.status);
            }
        }
    };

    // Send the AJAX request
    xhr.send();
}

function displayRequests(details) {
    var tableBody = document.getElementById('tbl');
    tableBody.innerHTML = ''; // Clear existing rows

    // Initialize a counter variable
    var counter = 1;

    for (var i = 0; i < details.length; i++) {
        var row = tableBody.insertRow(i);
        var cellId = row.insertCell(0);
        var cellName = row.insertCell(1);
        var cellTittle = row.insertCell(2);
        var cellTopic = row.insertCell(3);
        var cellStatus = row.insertCell(4);
        var cellAction = row.insertCell(5);

        // Use the counter variable for row numbers
        cellId.innerHTML = details[i].id;
        cellName.innerHTML = details[i].name;
        cellTittle.innerHTML = details[i].title;
        cellTopic.innerHTML = details[i].topic;
        cellStatus.innerHTML = details[i].status;

        if (details[i].status === 'pending') {
            cellStatus.style.color = 'red';
        }

        // Add action buttons or other UI elements as needed
        // For example, a button to view details
        cellAction.innerHTML = '<button class="edit-button" onclick="viewDetails(' + details[i].id + ')">View</button>';
    }
}

// Function to filter the table based on the search input
function searchTable() {
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById('searchInput');
    filter = input.value.toUpperCase();
    table = document.getElementById('mytable');
    tr = table.getElementsByTagName('tr');

    // Loop through all table rows, and hide those that don't match the search query
    for (i = 0; i < tr.length; i++) {
        td = tr[i].getElementsByTagName('td')[1]; // Index 1 corresponds to the "name" column
        if (td) {
            txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = '';
            } else {
                tr[i].style.display = 'none';
            }
        }
    }
}

function viewDetails(ID) {
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'fetch_request_details.php', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

    // Send the reservation ID to the PHP script
    xhr.send('id=' + encodeURIComponent(ID));

    // Handle the response from the PHP script
    xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
            if (xhr.status == 200) {
                try {
                    var response = JSON.parse(xhr.responseText);
                    if (response.status === 'success') {
                        displayDetailsModal(response.data);
                    } else {
                        alert('Error: ' + response.message);
                    }
                } catch (e) {
                    console.error('Error parsing JSON response:', e);
                    alert('Invalid JSON response from server');
                }
            } else {
                alert('Request failed with status: ' + xhr.status);
            }
        }
    };
}


function displayDetailsModal(user_data) {
     // Check if the modal element exists
    var modal = document.getElementById('exampleModalCenter');
    if (!modal) {
        console.error('Modal element not found');
        return;
    }

    document.getElementById("Author").textContent=user_data.author;
    document.getElementById("Publisher").textContent=user_data.publisher;
    document.getElementById("topic").textContent=user_data.topic;
    document.getElementById("BookID").textContent=user_data.book_id;
    document.getElementById("Status").textContent=user_data.status;

document.getElementById("timer").textContent = user_data.borrowed_date;
    
var statusElement = document.getElementById("Status");
statusElement.textContent = user_data.status;

var timerElement = document.getElementById("timer");
var timerRowElement = document.getElementById("timer_row");
var countdownInterval; // Variable to store the interval

function startCountdown() {
    var borrowedDate = new Date(user_data.borrowed_date).getTime();
    var twentyFourHoursLater = borrowedDate + 24 * 60 * 60 * 1000; // 24 hours in milliseconds

    // Update the timer every second
    countdownInterval = setInterval(function () {
        var now = new Date().getTime();
        var distance = twentyFourHoursLater - now;

        if (distance <= 0) {
            clearInterval(countdownInterval);
            timerElement.textContent = "Expired";
            markAsExpired(user_data.id);
        } else {
            var hours = Math.floor(distance / (1000 * 60 * 60));
            var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((distance % (1000 * 60)) / 1000);

            // Display the countdown in the format HH:MM:SS
            timerElement.textContent = hours + ":" + minutes + ":" + seconds;
        }
    }, 1000);
}

// Check if the status is pending
if (user_data.status.toLowerCase() === "pending") {
    statusElement.style.color = "red";

    // Hide the timer when the status is pending
    timerElement.classList.add("hidden");
    timerRowElement.classList.add("hidden");

}else if (user_data.status.toLowerCase() === "received") {
    // Calculate expected return date by adding 3 days to borrowed date
    const borrowedDate = new Date(user_data.borrowed_date);
    const expectedReturnDate = new Date(borrowedDate);
    expectedReturnDate.setDate(borrowedDate.getDate() + 3);

    // Format expected return date as a string (you may need to adjust the formatting based on your needs)
    const formattedReturnDate = expectedReturnDate.toDateString();

Swal.fire({
    icon: 'warning',
    title: 'Important Notice',
    html: 'This user is scheduled to endorse the book with a backing commitment on the designated date, as per administrative records. The expected return date is ' +
        '<strong>' + formattedReturnDate + '</strong>.<br>',
    confirmButtonColor: '#3085d6',
    confirmButtonText: 'OK',
    footer: '<button id="Returned" class="btn btn-secondary">Returned</button>'
}).then((result) => {
    // If user clicks OK, hide the modal and reload the page
    if (result.isConfirmed) {
        $(modal).modal('hide');
        location.reload();
    }
});



// Add click event listener to the "Returned" button
document.getElementById('Returned').addEventListener('click', function () {
     UpdateCopies_Status(user_data.book_id,user_data.id);
});


}



 else {
    // Show the timer for other statuses and start the countdown
    statusElement.style.color = "green";
    timerElement.classList.remove("hidden");
    timerRowElement.classList.remove("hidden");
    startCountdown();
}

    document.getElementById('accept').addEventListener('click', function() {
        if (user_data.id) {
            // Send AJAX request to update the user
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'update_borrow.php', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

            xhr.send('borrowed_id=' + encodeURIComponent(user_data.id));

            // Handle the response from the PHP script
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    if (xhr.status == 200) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            if (response.status === 'success') {
                                    Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: 'Update successfully.',
                            confirmButtonColor: '#3085d6',
                            confirmButtonText: 'OK'
                        }).then((result) => {
                            // If user clicks OK, refresh the page
                            if (result.isConfirmed) {
                                location.reload();
                            }
                        }); 
                            } else {
                                // Update failed, handle as needed
                                alert('Error updating user: ' + response.message);
                            }
                        } catch (e) {
                            // Invalid JSON response
                            console.error('Error parsing JSON response:', e);
                            console.log('Raw response:', xhr.responseText); // Log the raw response for debugging
                            alert('Invalid JSON response from server');
                        }
                    } else {
                        // Request failed, handle as needed
                        alert('Request failed with status: ' + xhr.status);
                    }
                }
            };
        } else {
            // No user selected, handle as needed
            alert('No user selected.');
        }
    });



     // Display the modal
    $(modal).modal('show');
}





function markAsExpired(request_id) {
    // Make a fetch request to your server-side script to update the database
    fetch('/markAsExpired.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            request_id: request_id,
        }),
    })
    .then(response => response.json())
    .then(data => {
        // Handle the response from the server if needed
        console.log(data);
    })
    .catch(error => {
        console.error('Error:', error);
    });
}






// Function to update the "Copies" column
function UpdateCopies_Status(bookId, requestId) {
    // Send an AJAX request to update the 'Copies' column
    var updateCopiesXHR = new XMLHttpRequest();
    updateCopiesXHR.open('POST', 'update_copies_status.php', true);
    updateCopiesXHR.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    updateCopiesXHR.onload = function () {
        if (updateCopiesXHR.status === 200) {
            // The update was successful, you can handle the response here if needed
            console.log('Copies updated successfully:' + updateCopiesXHR.responseText);
            
            // Show SweetAlert success popup
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Borrow Return successfully.',
                confirmButtonColor: '#3085d6',
                confirmButtonText: 'OK'
            }).then((result) => {
                // If user clicks OK, refresh the page
                if (result.isConfirmed) {
                    location.reload();
                }
            });
        } else {
            // The update failed
            console.error('Error updating copies:', updateCopiesXHR.status, updateCopiesXHR.statusText);
            alert('Error updating copies: ' + updateCopiesXHR.statusText);
        }
    };
    updateCopiesXHR.onerror = function () {
        console.error('Request failed');
    };

    // Send the bookId and userId to the server to update the "Copies" column
    updateCopiesXHR.send('bookId=' + encodeURIComponent(bookId) + '&requestId=' + encodeURIComponent(requestId));
}









// JavaScript function to close the modal and reload the page
function closeAndReload() {
    // Close the modal
    var modal = document.getElementById('exampleModalCenter');
    $(modal).modal('hide'); // Using jQuery to close Bootstrap modal

    // Reload the page
    location.reload();
}

// Add an event listener to the close button
document.getElementById('closeModalButton').addEventListener('click', closeAndReload);




</script>






      </div>
      <!-- page-body-wrapper ends -->
    </div>
    <!-- container-scroller -->
    <!-- plugins:js -->
    <script src="assets/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- Plugin js for this page -->
    <!-- End plugin js for this page -->
    <!-- inject:js -->
    <script src="assets/js/off-canvas.js"></script>
    <script src="assets/js/hoverable-collapse.js"></script>
    <script src="assets/js/misc.js"></script>
    <!-- endinject -->
    <!-- Custom js for this page -->
    <!-- End custom js for this page -->
  </body>
</html>